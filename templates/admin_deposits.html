<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin ‚Äì Utilisateurs, D√©p√¥ts & Retraits | LuminaStar</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body {
    font-family:'Poppins',sans-serif;
    margin:0;
    padding:0;
    background: linear-gradient(135deg, #ff7eb3, #ff758c, #ffb199);
    color:#fff;
    min-height:100vh;
}

/* ===== Topbar & Sidebar ===== */
.topbar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:15px 20px;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(15px);
    position: sticky;
    top:0;
    z-index:1000;
}
.topbar .menu-toggle { font-size:24px; cursor:pointer; color:#fff; }
.topbar .user { font-weight:600; font-size:16px; }

.sidebar {
    position:fixed;
    left:-260px;
    top:0;
    height:100%;
    width:260px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(12px);
    transition:0.4s;
    padding-top:80px;
    z-index:999;
    border-right:1px solid rgba(255,255,255,0.25);
}
.sidebar.active { left:0; }
.sidebar a { display:block; padding:14px 25px; font-size:15px; color:#fff; text-decoration:none; transition:0.3s;}
.sidebar a i { margin-right:12px; }
.sidebar a:hover { background: rgba(255,255,255,0.25); }

.overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.45); opacity:0; visibility:hidden; transition:0.3s; z-index:998;}
.overlay.active { opacity:1; visibility:visible; }

.main { padding:20px; }

/* ===== Tabs ===== */
.tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.tab-btn {
    padding:10px 20px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    background: rgba(255,255,255,0.25);
    color:#fff;
    transition:0.3s;
}
.tab-btn.active { background:#2575fc; color:#fff; }

.tab-content { display:none; animation:fadeUp 0.6s ease; }
.tab-content.active { display:block; }

/* ===== Tables ===== */
.table-container {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(12px);
    padding:20px;
    border-radius:20px;
    overflow-x:auto;
    box-shadow:0 10px 30px rgba(0,0,0,0.2);
}

table {
    width:100%;
    border-collapse:collapse;
    color:#fff;
}

table th, table td {
    padding:12px 10px;
    text-align:left;
    border-bottom:1px solid rgba(255,255,255,0.25);
}

table th { background: rgba(37,117,252,0.8); color:#fff; position:sticky; top:0; z-index:10; }
table tr:hover { background: rgba(255,255,255,0.1); transition:0.3s; }

.badge {
    display:inline-block;
    padding:3px 10px;
    border-radius:12px;
    font-size:12px;
    font-weight:600;
}
.level1 { background:#ff7a00; }
.level2 { background:#2575fc; }
.level3 { background:#00c851; }

/* ===== Buttons ===== */
button {
    padding:6px 12px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    color:#fff;
    font-weight:500;
    transition:0.3s;
}
.valider { background:#28a745; }
.refuser { background:#dc3545; }
.activer { background:#2575fc; }

/* ===== Actions boutons c√¥te √† c√¥te ===== */
.action-buttons{
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: flex-start;
    flex-wrap: nowrap;
}

.action-buttons button{
    min-width: 90px;
}

/* ===== Flash messages ===== */
.flash {
    margin-bottom:15px;
    padding:10px;
    border-radius:6px;
}
.flash.success { background:rgba(40,167,69,0.2); }
.flash.danger { background:rgba(220,53,69,0.2); }
.flash.warning { background:rgba(255,193,7,0.2); }

/* ===== Animations ===== */
@keyframes fadeUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }

h3{
    margin: 0 0 15px 0;
    font-size: 18px;
}

.search-box{
    margin-bottom: 12px;
}

.search-box input{
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    border: none;
    outline: none;
    font-size: 14px;
    background: rgba(255,255,255,0.95);
    color: #333;
}

/* ===== Pagination ===== */
.pagination{
    margin-top: 15px;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
    font-weight:600;
}
.pagination a{
    text-decoration:none;
    color:#fff;
    background: rgba(255,255,255,0.25);
    padding:8px 12px;
    border-radius:10px;
    transition:0.3s;
}
.pagination a:hover{
    background: rgba(255,255,255,0.35);
}
</style>
</head>

<body>
<div class="overlay" id="overlay"></div>
<div class="sidebar" id="sidebar">
    <a href="/admin/deposits"><i class="fa fa-home"></i> Tableau de bord</a>
    <a href="/logout"><i class="fa fa-sign-out"></i> D√©connexion</a>
</div>

<div class="topbar">
    <div class="menu-toggle" id="menuToggle"><i class="fa fa-bars"></i></div>
    <div class="user">{{ user.username }}</div>
</div>

<div class="main">
    <h2>Administration ‚Äì Utilisateurs, D√©p√¥ts & Retraits</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Onglets -->
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab(event,'usersTab')">üë• Tous les utilisateurs</button>
        <button class="tab-btn" onclick="showTab(event,'depotsTab')">üí∞ D√©p√¥ts</button>
        <button class="tab-btn" onclick="showTab(event,'retraitsTab')">üí∏ Retraits</button>
        <button class="tab-btn" onclick="showTab(event,'actifsTab')">‚úÖ Actifs</button>
        <button class="tab-btn" onclick="showTab(event,'inactifsTab')">‚ùå Inactifs</button>
    </div>

<div class="search-box">
    <input type="text" id="userSearch" placeholder="Rechercher un utilisateur (username, email, t√©l√©phone, parrain)...">
</div>

<!-- ===== USERS (TOUS) ===== -->
<div id="usersTab" class="tab-content active">
    <div class="table-container">
        <table id="usersTable">
            <thead>
                <tr>
                    <th>Nom d'utilisateur</th>
                    <th>Email</th>
                    <th>T√©l√©phone</th>
                    <th>Parrain</th>
                    <th>Niveau 1</th>
                    <th>Niveau 2</th>
                    <th>Niveau 3</th>
                    <th>Premier d√©p√¥t</th>
                    <th>Date d'inscription</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td>{{ u.username }}</td>
                    <td>{{ u.email }}</td>
                    <td>{{ u.phone }}</td>
                    <td>{{ u.parrain }}</td>
                    <td><span class="badge level1">{{ u.niveau1 }}</span></td>
                    <td><span class="badge level2">{{ u.niveau2 }}</span></td>
                    <td><span class="badge level3">{{ u.niveau3 }}</span></td>
                    <td>
                        {% if u.premier_depot %}
                            <span class="badge level3">Actif</span>
                        {% else %}
                            <span class="badge level1">Inactif</span>
                        {% endif %}
                    </td>
                    <td>{{ u.date_creation.strftime('%d/%m/%Y') if u.date_creation else '-' }}</td>

                    <td>
                        {% if not u.premier_depot %}
                            <a href="{{ url_for('admin_activer_user', username=u.username) }}">
                                <button class="activer">Activer</button>
                            </a>
                        {% else %}
                            <span class="badge level3">D√©j√† actif</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}

                {% if users|length == 0 %}
                <tr>
                    <td colspan="10">Aucun utilisateur trouv√©.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>

        <!-- ‚úÖ Pagination utilisateurs supprim√©e -->
    </div>
</div>

<!-- ===== DEPOTS ===== -->
<div id="depotsTab" class="tab-content">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Utilisateur</th>
                    <th>Email</th>
                    <th>Nom</th>
                    <th>Op√©rateur</th>
                    <th>Pays</th>
                    <th>Montant</th>
                    <th>Statut</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for d in depots %}
                <tr>
                    <td>{{ d.id }}</td>
                    <td>{{ d.phone }}</td>
                    <td>{{ d.email or '-' }}</td>
                    <td>{{ d.user_name or '-' }}</td>
                    <td>{{ d.operator or '-' }}</td>
                    <td>{{ d.country or '-' }}</td>
                    <td>{{ d.montant }}</td>
                    <td class="status-{{ d.statut }}">{{ d.statut }}</td>
                    <td>{{ d.date.strftime('%d/%m/%Y %H:%M') }}</td>

                    <td>
                        {% if d.statut == 'pending' %}
                            <div class="action-buttons">
                                <a href="{{ url_for('rejeter_depot', depot_id=d.id) }}">
                                    <button class="refuser">Rejeter</button>
                                </a>

                                <a href="{{ url_for('valider_depot', depot_id=d.id) }}">
                                    <button class="valider">Valider</button>
                                </a>
                            </div>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}

                {% if depots|length == 0 %}
                <tr>
                    <td colspan="10">Aucun d√©p√¥t en attente.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- ===== RETRAITS ===== -->
<div id="retraitsTab" class="tab-content">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Utilisateur</th>
                    <th>Montant</th>
                    <th>Frais</th>
                    <th>Moyen</th>
                    <th>Num√©ro</th>
                    <th>Pays</th>
                    <th>Date</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for r in retraits %}
                <tr>
                    <td>{{ r.id }}</td>
                    <td>{{ r.username }}</td>
                    <td>{{ r.montant }} XOF</td>
                    <td>{{ r.frais }} XOF</td>
                    <td>{{ r.payment_method }}</td>
                    <td>{{ r.phone }}</td>
                    <td>{{ r.pays }}</td>
                    <td>{{ r.date.strftime("%d/%m/%Y") }}</td>
                    <td>{{ r.statut }}</td>

                    <td>
                        <div class="action-buttons">
                            <a href="/admin/retraits/refuser/{{ r.id }}">
                                <button class="refuser">Refuser</button>
                            </a>

                            <a href="/admin/retraits/valider/{{ r.id }}">
                                <button class="valider">Valider</button>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}

                {% if retraits|length == 0 %}
                <tr>
                    <td colspan="10">Aucun retrait en attente.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>

        <!-- Pagination retraits -->
        <div class="pagination">
            {% if retraits_paginated.has_prev %}
                <a href="{{ url_for('admin_deposits', page=retraits_paginated.prev_num) }}">¬´ Pr√©c√©dent</a>
            {% endif %}

            Page {{ retraits_paginated.page }} sur {{ retraits_paginated.pages }}

            {% if retraits_paginated.has_next %}
                <a href="{{ url_for('admin_deposits', page=retraits_paginated.next_num) }}">Suivant ¬ª</a>
            {% endif %}
        </div>
    </div>
</div>

<!-- ===== ACTIFS ===== -->
<div id="actifsTab" class="tab-content">
    <div class="table-container">
        <h3>‚úÖ Utilisateurs Actifs <span class="badge level3">{{ total_actifs }}</span></h3>

        <table>
            <thead>
                <tr>
                    <th>Nom d'utilisateur</th>
                    <th>Email</th>
                    <th>T√©l√©phone</th>
                    <th>Parrain</th>
                    <th>Date d'inscription</th>
                </tr>
            </thead>
            <tbody>
                {% for u in actifs %}
                <tr>
                    <td>{{ u.username }}</td>
                    <td>{{ u.email }}</td>
                    <td>{{ u.phone }}</td>
                    <td>{{ u.parrain }}</td>
                    <td>{{ u.date_creation.strftime('%d/%m/%Y') if u.date_creation else '-' }}</td>
                </tr>
                {% endfor %}

                {% if actifs|length == 0 %}
                <tr>
                    <td colspan="5">Aucun utilisateur actif.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- ===== INACTIFS ===== -->
<div id="inactifsTab" class="tab-content">
    <div class="table-container">
        <h3>‚ùå Utilisateurs Inactifs <span class="badge level1">{{ total_inactifs }}</span></h3>

        <table>
            <thead>
                <tr>
                    <th>Nom d'utilisateur</th>
                    <th>Email</th>
                    <th>T√©l√©phone</th>
                    <th>Parrain</th>
                    <th>Date d'inscription</th>
                </tr>
            </thead>
            <tbody>
                {% for u in inactifs %}
                <tr>
                    <td>{{ u.username }}</td>
                    <td>{{ u.email }}</td>
                    <td>{{ u.phone }}</td>
                    <td>{{ u.parrain }}</td>
                    <td>{{ u.date_creation.strftime('%d/%m/%Y') if u.date_creation else '-' }}</td>
                </tr>
                {% endfor %}

                {% if inactifs|length == 0 %}
                <tr>
                    <td colspan="5">Aucun utilisateur inactif.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

</div>

<script>
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");
const menuToggle = document.getElementById("menuToggle");

menuToggle.onclick = () => {
    sidebar.classList.add("active");
    overlay.classList.add("active");
};

overlay.onclick = () => {
    sidebar.classList.remove("active");
    overlay.classList.remove("active");
};

function showTab(e, tabId){
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

    document.getElementById(tabId).classList.add('active');

    const btn = e.currentTarget || e.target;
    btn.classList.add('active');
}

document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("userSearch");
    const usersTableBody = document.querySelector("#usersTab table tbody");

    if (!searchInput || !usersTableBody) return;

    searchInput.addEventListener("keyup", () => {
        const value = searchInput.value.toLowerCase().trim();
        const rows = usersTableBody.querySelectorAll("tr");

        rows.forEach(row => {
            const rowText = row.innerText.toLowerCase();
            row.style.display = rowText.includes(value) ? "" : "none";
        });
    });
});
</script>
</body>
</html>
